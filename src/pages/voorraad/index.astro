---
import Button from "../../components/Button.astro";
import SanityImage from "../../components/SanityImage.astro";
import Title from "../../components/Title.astro";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getMerken, getVoorraad } from "../../sanity";

const { searchParams } = Astro.url;

const selectedMerk = searchParams.get("merk");
const selectedVerkocht = searchParams.get("verkocht");
const merken = await getMerken();

const voorraadItems = await getVoorraad({
  ...(selectedMerk && { merk: selectedMerk }),
  ...(selectedVerkocht && { verkocht: selectedVerkocht === "true" }),
});
---

<BaseLayout
  title="Voorraad"
  description="De voorraad van de The Mechanic"
  transparentHeader
>
  <div class="bg-sand min-h-dvh p-4 pt-60">
    <div class="container mx-auto max-w-6xl">
      <div class="mb-8 flex flex-col gap-4 md:flex-row">
        <select
          name="merk"
          class="px-12"
          hx-get="/voorraad"
          hx-push-url="true"
          hx-target="#results"
          hx-select="#results"
          hx-swap="outerHTML"
          hx-include="[name=verkocht]"
        >
          <option value="">Alle merken</option>
          {
            merken.map((merk) => (
              <option value={merk.naam} selected={selectedMerk === merk.naam}>
                {merk.naam}
              </option>
            ))
          }
        </select>
        <select
          class="px-12"
          name="verkocht"
          hx-get="/voorraad"
          hx-push-url="true"
          hx-target="#results"
          hx-select="#results"
          hx-swap="outerHTML"
          hx-include="[name=merk]"
        >
          <option value="false" selected={selectedVerkocht === "false"}
            >Beschikbaar</option
          >
          <option value="true" selected={selectedVerkocht === "true"}
            >Verkocht</option
          >
        </select>
      </div>

      <div id="results" class="flex flex-col gap-8">
        {
          voorraadItems.length ? (
            voorraadItems.map((item) => {
              return (
                <a href={`/voorraad/${item.slug!.current}`}>
                  <div class="flex flex-col overflow-hidden rounded-2xl bg-white md:flex-row">
                    <div
                      class="aspect-[4/3] basis-1/2 overflow-hidden"
                      transition:name={item.fotos?.[0]._key}
                    >
                      <SanityImage
                        image={item.fotos?.[0].asset!._ref}
                        alt={item.titel!}
                        width={400}
                        height={300}
                        class="h-full w-full object-cover"
                      />
                    </div>
                    <div class="space-y-6 px-8 py-12">
                      <Title class="text-primary text-2xl" variant="tertiary">
                        {item.merk?.naam}&nbsp;{item.titel}
                      </Title>
                      {/* <p class="text-sm font-light text-pretty">
                        {item.highlight}
                      </p> */}
                      <div class="mt-2 grid grid-cols-3">
                        <div class="space-y-1">
                          <dt class="text-neutral-400">Bouwjaar</dt>
                          <dd class="font-light">{item.bouwjaar}</dd>
                        </div>
                        <div class="space-y-1">
                          <dt class="text-neutral-400">Km stand</dt>
                          <dd class="font-light">
                            {Intl.NumberFormat("nl-NL").format(
                              item?.kilometerstand || 0
                            )}
                          </dd>
                        </div>
                        <div class="space-y-1">
                          <dt class="text-neutral-400">Prijs</dt>
                          <dd class="font-light">
                            {item.prijs
                              ? Intl.NumberFormat("nl-NL", {
                                  style: "currency",
                                  currency: "EUR",
                                }).format(item.prijs)
                              : "Op aanvraag"}
                          </dd>
                        </div>
                      </div>
                      <Button
                        size="sm"
                        class="w-full cursor-pointer md:w-auto"
                        variant="primary"
                      >
                        Bekijk model
                      </Button>
                    </div>
                  </div>
                </a>
              );
            })
          ) : (
            <div class="w-full py-12 text-center">
              <p>Geen voertuigen gevonden met de geselecteerde filters.</p>
            </div>
          )
        }
      </div>
    </div>
  </div>
</BaseLayout>
<script>
  document.addEventListener("astro:page-load", () => {
    // @ts-ignore
    htmx.process(document.body);
  });
</script>
